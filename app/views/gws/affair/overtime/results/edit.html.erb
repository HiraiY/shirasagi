<%= jquery do %>
//$('#ajax-form').ajaxForm({
//  success: function(data) {
//    $("#addon-gws-agents-addons-affair-overtime_result .overtime-results").replaceWith(data);
//    $.colorbox.close();
//    SS.notice('<%= t('ss.notice.saved') %>');
//  },
//  error: function(data, status, err) {
//    resp = eval(data.responseText);
//    alert(resp.join("\n"));
//  }
//});
var deleteResult = function() {
  var item = $(this).closest(".item");
  if($(item).find(".start-at").val() || $(item).find(".end-at").val() || $(item).find("select").val()){
    if(!confirm('削除してよろしいですか？')) {
      return false;
    }
  }
  if ($(".items .item").length > 1) {
    $(item).remove();
  } else {
    $(item).find("input").val("");
    $(item).find("select").val("");
  }
  return false;
};
$(".delete-result").on("click", deleteResult);

<% end %>

<%= form_tag({ action: :update }, { id: "ajax-form", method: :put, autocomplete: :off }) do %>

<%= hidden_field_tag "ref", params[:ref] %>

<% @items.each do |item| %>
  <div class="addon-view" id="addon-gws-agents-addons-affair-overtime_file">
    <div class="addon-head toggle-head"><h2><%= "#{item.date.strftime("%Y/%m/%d")} : #{item.name}" %></h2></div>
    <div class="addon-body toggle-body" style="display: none;">
      <dl class="see addon-gws-affair-overtime_file">
        <dt><%= item.t :overtime_name %></dt>
        <dd><%= item.overtime_name %></dd>

        <dt><%= item.t :capital_id %></dt>
        <dd><%= tryb { item.capital.name } %></dd>

        <dt><%= item.t :start_at %></dt>
        <dd><%= tryb { item.start_at.strftime("%Y/%m/%d %H:%M") } %></dd>

        <dt><%= item.t :end_at %></dt>
        <dd><%= tryb { item.end_at.strftime("%Y/%m/%d %H:%M") } %></dd>

        <% if item.week_in_compensatory_minute.present?  %>
          <dt><%= item.t :week_in_compensatory_minute %></dt>
          <dd><%= item.label :week_in_compensatory_minute %></dd>
        <% end %>

        <% if item.week_out_compensatory_minute.present?  %>
          <dt><%= item.t :week_out_compensatory_minute %></dt>
          <dd><%= item.label :week_out_compensatory_minute %></dd>
        <% end %>

        <% if item.remark.present? %>
          <dt><%= item.t :remark %></dt>
          <dd><%=br item.remark %></dd>
        <% end %>
      </dl>
    </div>
  </div>

  <%
    date_options = [item.date, item.date.advance(days: 1)].map { |date| [date.strftime("%Y/%m/%d"), date.strftime("%Y/%m/%d")] }
    hour_options = (0..23).map { |h| [ "#{h}#{I18n.t('datetime.prompts.hour')}", h.to_s ] }
    minute_options = (0..59).select { |m| m % 5 == 0 }.map { |m| [ "#{m}#{I18n.t('datetime.prompts.minute')}", m.to_s ] }
    break_time_minute_options = (0..60).select { |m| m % 5 == 0 }.map { |m| [ "#{m}#{I18n.t('datetime.prompts.minute')}", m.to_s ] }

    if item.result
      start_at_date = item.result.start_at.strftime("%Y/%m/%d")
      start_at_hour = item.result.start_at.hour
      start_at_minute = item.result.start_at.minute

      end_at_date = item.result.end_at.strftime("%Y/%m/%d")
      end_at_hour = item.result.end_at.hour
      end_at_minute = item.result.end_at.minute

      break_time_minute = item.result.break_time_minute
    else
      start_at_date = item.start_at.strftime("%Y/%m/%d")
      start_at_hour = item.start_at.hour
      start_at_minute = item.start_at.minute

      end_at_date = item.end_at.strftime("%Y/%m/%d")
      end_at_hour = item.end_at.hour
      end_at_minute = item.end_at.minute
    end
  %>
  <table class="index" style="margin-bottom: 10px;">
    <thead class="list-head">
      <tr>
        <th class="start-at"><%= Gws::Affair::OvertimeResult.t("start_at") %></th>
        <th class="end-at"><%= Gws::Affair::OvertimeResult.t("end_at") %></th>
        <th class="break-time"><%= Gws::Affair::OvertimeResult.t("break_time_minute") %></th>
      </tr>
    </thead>
    <tbody class="items">
      <tr class="item">
        <td class="start-at">
          <%= select_tag "item[in_results][#{item.id}][start_at_date]", options_for_select(date_options, start_at_date), include_blank: true %>
          <%= select_tag "item[in_results][#{item.id}][start_at_hour]", options_for_select(hour_options, start_at_hour), include_blank: true %>
          <%= select_tag "item[in_results][#{item.id}][start_at_minute]", options_for_select(minute_options, start_at_minute), include_blank: true %>
        </td>
      <td class="end-at">
        <%= select_tag "item[in_results][#{item.id}][end_at_date]", options_for_select(date_options, end_at_date), include_blank: true %>
        <%= select_tag "item[in_results][#{item.id}][end_at_hour]", options_for_select(hour_options, end_at_hour), include_blank: true %>
        <%= select_tag "item[in_results][#{item.id}][end_at_minute]", options_for_select(minute_options, end_at_minute), include_blank: true %>
      </td>
        <td class="break-time"><%= select_tag "item[in_results][#{item.id}][break_time_minute]", options_for_select(break_time_minute_options, break_time_minute) %></td>
      </tr>
    </tbody>
  </table>
<% end %>

<footer class="send">
  <%= submit_tag t("ss.buttons.save"), class: "btn-primary save" %>
  <%= link_to t("ss.buttons.cancel"), "", class: "btn btn-default", onclick: "$.colorbox.close(); return false;" %>
</footer>

<% end %>
