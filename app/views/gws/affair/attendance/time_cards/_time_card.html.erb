<% render_reason = proc do |history| %>
  <% if history.present? && history.reason.present? %>
    <div class="reason-tooltip">
      <i class="material-icons md-13">&#xE0C9;</i>
      <div class="reason">
        <div><%= history.reason %></div>
        <time datetime="<%= history.created.iso8601 %>"><%= history.created.strftime('%Y/%m/%d %H:%M') %></time>
      </div>
    </div>
  <% end %>
<% end %>

<% render_time = proc do |date, record, field_name| %>
  <% td_classes = %w(time) %>
  <% td_classes << field_name %>
  <% td_classes << (date.day >= 16 ? 'top' : nil) %>
  <% mode = "edit" %>
  <% mode = "punch" if record.try(:find_latest_history, field_name).blank? && Time.zone.now.beginning_of_day == date %>
  <td class="<%= td_classes.join(' ') %>" data-day="<%= date.day %>" data-type="<%= field_name %>" data-mode="<%= mode %>">
    <%= format_time(date, record.try(field_name)) %>
    <% render_reason.call(record.try(:find_latest_history, field_name)) %>
  </td>
<% end %>

<%
  overtime_day_results = {}
  Gws::Affair::OvertimeDayResult.site(@cur_site).user(@cur_user).and(
    { "date" => { "$gte" => @cur_month } },
    { "date" => { "$lte" => @cur_month.end_of_month } },
  ).each do |item|
    overtime_day_results[item.date] ||= []
    overtime_day_results[item.date] << item
  end

  leave_files = {}
  Gws::Affair::LeaveFile.site(@cur_site).user(@cur_user).and(
    { "start_at" => { "$gte" => @cur_month } },
    { "start_at" => { "$lte" => @cur_month.end_of_month } },
    { "workflow_state" => "approve" }
  ).each do |item|
    leave_files[item.date] ||= []
    leave_files[item.date] << item
  end

  def format_minute(minute)
    (minute.to_i > 0) ? "#{minute / 60}:#{format("%02d", (minute % 60))}" : "--:--"
  end
%>

<div class="time-card-wrap">
  <table class="time-card">
    <tbody>
    <% date = @cur_month %>
    <% while date <= @cur_month.end_of_month %>
      <% offset = date.day >= 16 ? 'top' : '' %>
      <% if date.day == 1 %>
        <tr class="header">
          <th colspan="<%= 3 + @break_times.size * 2 %>"><%= "勤務" %></th>
          <th class="overtime time" colspan="3"><%= "時間外" %></th>
          <th class="leave" rowspan="2"><%= "休暇" %></th>
          <th class="memo" rowspan="2"><%= Gws::Attendance::Record.t(:memo) %></th>
        </tr>
        <tr class="header">
          <th class="date"><%= Gws::Attendance::Record.t(:date) %></th>
          <th class="time enter"><%= @cur_site.attendance_enter_label.presence || Gws::Attendance::Record.t(:enter) %></th>
          <th class="time leave"><%= @cur_site.attendance_leave_label.presence || Gws::Attendance::Record.t(:leave) %></th>
          <% @break_times.each do |i| %>
            <th class="time <%= "break_enter#{i + 1}" %>"><%= @cur_site["attendance_break_enter#{i + 1}_label"].presence || t('gws/attendance.formats.break_enter', count: i + 1) %></th>
            <th class="time <%= "break_leave#{i + 1}" %>"><%= @cur_site["attendance_break_leave#{i + 1}_label"].presence || t('gws/attendance.formats.break_leave', count: i + 1) %></th>
          <% end %>
          <th class="overtime time"><%= "執務時間 (結果 | 差分)" %></th>
          <th class="break-time"><%= "休憩" %></th>
          <th class="compensatory-time"><%= "振替" %></th>
        <tr>
    　<% end %>
      <% if date.day == 16 %>
        <tr class="header">
          <th class="date"><%= Gws::Attendance::Record.t(:date) %></th>
          <th class="time enter"><%= @cur_site.attendance_enter_label.presence || Gws::Attendance::Record.t(:enter) %></th>
          <th class="time leave"><%= @cur_site.attendance_leave_label.presence || Gws::Attendance::Record.t(:leave) %></th>
          <% @break_times.each do |i| %>
            <th class="time <%= "break_enter#{i + 1}" %>"><%= @cur_site["attendance_break_enter#{i + 1}_label"].presence || t('gws/attendance.formats.break_enter', count: i + 1) %></th>
            <th class="time <%= "break_leave#{i + 1}" %>"><%= @cur_site["attendance_break_leave#{i + 1}_label"].presence || t('gws/attendance.formats.break_leave', count: i + 1) %></th>
          <% end %>
          <th class="overtime time"><%= "時間外 (結果 | 差分)" %></th>
          <th class="break-time"><%= "休憩" %></th>
          <th class="compensatory-time"><%= "振替" %></th>
          <th class="leave"><%= "休暇" %></th>
          <th class="memo"><%= Gws::Attendance::Record.t(:memo) %></th>
        </tr>
      <% end %>
      <% tr_css_classes = [ "day-#{date.day}" ] %>
      <% tr_css_classes << (Time.zone.now.beginning_of_day == date ? 'current' : nil) %>
      <% tr_css_classes << 'holiday' if holiday?(date) %>
      <% tr_css_classes << 'sunday' if date.wday == 0 %>
      <% tr_css_classes << 'saturday' if date.wday == 6 %>
      <tr class="<%= tr_css_classes.compact.join(' ') %>" data-day="<%= date.day %>">
        <% record = @item.records.where(date: date).first %>
        <td class="date"><%= I18n.l(date.to_date, format: :attendance_month_day) %></td>
        <% render_time.call(date, record, 'enter') %>
        <% render_time.call(date, record, 'leave') %>
        <% @break_times.each do |i| %>
          <% render_time.call(date, record, "break_enter#{i + 1}") %>
          <% render_time.call(date, record, "break_leave#{i + 1}") %>
        <% end %>

        <%
          overtime_minute = 0
          overtime_minute = record.overtime_minute if record

          day_results = overtime_day_results[date.to_datetime]

          compensatory_minute = 0
          if day_results.present?
            compensatory_minute = day_results.map(&:week_in_compensatory_minute).sum
            compensatory_minute += day_results.map(&:week_out_compensatory_minute).sum
          end

          break_time_minute = 0
          if day_results.present?
            break_time_minute = day_results.map(&:break_time_minute).sum
          end

          overtime_minute = (overtime_minute - compensatory_minute) > 0 ? (overtime_minute - compensatory_minute) : 0
          overtime_minute = (overtime_minute - break_time_minute) > 0 ? (overtime_minute - break_time_minute) : 0
        %>
        <td class="overtime time">
          <%= format_minute(overtime_minute.to_i) %>

          <% if day_results.present? %>
            <%= " (" %>
            <% result_minute = day_results.pluck(:overtime_minute).sum %>
            <%= format_minute(result_minute) %>

            <% if day_results.present? && result_minute %>
              <%= " | " %>
              <% overtime_diff = result_minute - overtime_minute %>
              <% if overtime_diff == 0 %>
                <% label = format_minute(overtime_diff) %>
                <%= link_to label, edit_gws_affair_overtime_result_path(id: day_results.first.file.id, ref: request.path), class: "ajax-box overtime-diff equal" %>
              <% elsif overtime_diff > 0 %>
                <% label = "-" + format_minute(overtime_diff) %>
                <%= link_to label, edit_gws_affair_overtime_result_path(id: day_results.first.file.id, ref: request.path), class: "ajax-box overtime-diff minus" %>
              <% else %>
                <% overtime_diff = overtime_diff * -1 %>
                <% label = "+" + format_minute(overtime_diff) %>
                <%= link_to label, edit_gws_affair_overtime_result_path(id: day_results.first.file.id, ref: request.path), class: "ajax-box overtime-diff plus" %>
              <% end %>
            <% end %>
            <%= ")" %>
          <% end %>
        </td>

        <%
          day_results = overtime_day_results[date.to_datetime]
          if day_results.present?
            break_time_minute = day_results.map(&:break_time_minute).sum
          else
            break_time_minute = 0
          end
        %>
        <td class="time"><%= format_minute(break_time_minute) %></td>

        <%
          day_results = overtime_day_results[date.to_datetime]
          compensatory_minute_labels = []
          if day_results.present?
            day_results.each do |result|
              if result.week_in_compensatory_minute > 0
                compensatory_minute_labels << "週内#{format_minute(result.week_in_compensatory_minute)}"
              end
              if result.week_out_compensatory_minute > 0
                compensatory_minute_labels << "週外#{format_minute(result.week_out_compensatory_minute)}"
              end
            end
          end
          compensatory_minute_labels << format_minute(0) if compensatory_minute_labels.blank?
        %>
        <td class="time"><%=br compensatory_minute_labels.join("\n") %></td>

        <td>
          <% (leave_files[date.to_datetime] || []).each do |leave_file|%>
            <div class="leave-file">
              <%= leave_file.label :leave_type %>
              <div class="leave-file-tooltip" data-href="<%= gws_affair_leave_apis_file_path(id: leave_file.id) %>">
                <i class="material-icons md-13">&#xE0C9;</i>
              </div>
            </div>
          <% end %>
        </td>

        <td class="memo <%= offset %>" data-day="<%= date.day %>" data-type="memo" data-mode="edit"><%= record ? record.memo : '' %></td>
      </tr>
      <% date += 1.day %>
    <% end %>
    </tbody>
  </table>
</div>

<div class="cell-toolbar">
  <a href="#" class="punch" data-confirmation="<%= t('gws/attendance.confirm.punch') %>"><%= t('gws/attendance.links.punch') %></a>
  <a href="#" class="edit ajax-box"><%= t('ss.links.edit') %></a>
</div>
